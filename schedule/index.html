<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engineer Availability Schedule</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #1a1a2e;
        color: #e0e0e0;
        min-height: 100vh;
        padding: 24px;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #fff;
      }
      .subtitle {
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 20px;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .controls label {
        font-size: 0.85rem;
        color: #aaa;
      }
      .controls select {
        background: #16213e;
        color: #e0e0e0;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 0.85rem;
        cursor: pointer;
        appearance: auto;
      }
      .controls select:focus {
        outline: none;
        border-color: #4cc9f0;
      }
      .current-time {
        font-size: 0.85rem;
        color: #4cc9f0;
        font-weight: 500;
        margin-left: auto;
      }
      .edit-hint {
        font-size: 0.75rem;
        color: #666;
        background: #16213e;
        padding: 4px 10px;
        border-radius: 4px;
        border: 1px solid #2a2a4a;
      }
      .edit-hint kbd {
        background: #2a2a4a;
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 0.7rem;
        color: #4cc9f0;
      }
      .schedule-wrapper {
        overflow-x: auto;
        border-radius: 10px;
        border: 1px solid #2a2a4a;
        position: relative;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        min-width: 900px;
      }
      th,
      td {
        padding: 0;
        text-align: center;
        border: 1px solid #2a2a4a;
        position: relative;
      }
      .name-col {
        width: 140px;
        min-width: 140px;
        text-align: left;
        padding: 8px 12px;
        font-weight: 500;
        position: sticky;
        left: 0;
        z-index: 2;
        background: #16213e;
        white-space: nowrap;
      }
      .name-col .pencil {
        cursor: pointer;
        font-size: 0.7rem;
        margin-left: 6px;
        opacity: 0.4;
        transition: opacity 0.2s;
      }
      .name-col:hover .pencil {
        opacity: 1;
      }
      .notes-col {
        width: 220px;
        min-width: 180px;
        text-align: left;
        padding: 8px 12px;
        font-size: 0.75rem;
        color: #999;
        font-style: italic;
      }
      .hour-header {
        padding: 6px 4px;
        font-size: 0.75rem;
        font-weight: 600;
        background: #16213e;
        color: #aaa;
        min-width: 38px;
      }
      .hour-header.highlight {
        color: #4cc9f0;
      }
      .hour-cell {
        padding: 0;
        height: 36px;
        min-width: 38px;
        transition: background 0.15s;
        cursor: default;
      }
      .hour-cell.available {
        background: #2d6a4f;
      }
      .hour-cell.available:hover {
        background: #40916c;
      }
      .hour-cell:not(.available):hover {
        background: #1e2a4a;
      }
      .name-row:hover .name-col {
        background: #1e2a4a;
      }
      .header-row th {
        border-bottom: 2px solid #333;
      }
      .current-time-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #f72585;
        z-index: 5;
        pointer-events: none;
      }
      .current-time-dot {
        position: absolute;
        top: -5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #f72585;
        left: -4px;
      }

      /* Tooltip */
      .tooltip {
        position: fixed;
        background: #0f1629;
        border: 1px solid #4cc9f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.8rem;
        z-index: 100;
        pointer-events: none;
        max-width: 320px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        line-height: 1.5;
      }
      .tooltip .tt-name {
        font-weight: 700;
        color: #fff;
        font-size: 0.9rem;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .tooltip .tt-status {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      .tooltip .tt-status.online {
        background: #2d6a4f;
      }
      .tooltip .tt-status.offline {
        background: #555;
      }
      .tooltip .tt-row {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        color: #bbb;
      }
      .tooltip .tt-label {
        color: #888;
      }
      .tooltip .tt-value {
        color: #e0e0e0;
        font-weight: 500;
        text-align: right;
      }
      .tooltip .tt-divider {
        border-top: 1px solid #2a2a4a;
        margin: 6px 0;
      }

      /* Legend */
      .legend {
        display: flex;
        gap: 20px;
        margin-top: 16px;
        font-size: 0.8rem;
        color: #888;
        align-items: center;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .legend-swatch {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      /* Engineer detail panel */
      .detail-panel {
        margin-top: 24px;
      }
      .detail-panel h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 12px;
      }
      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 12px;
      }
      .eng-card {
        background: #16213e;
        border: 1px solid #2a2a4a;
        border-radius: 8px;
        padding: 14px 18px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .eng-card.offline-card {
        opacity: 0.45;
      }
      .eng-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .eng-card-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .eng-card-name .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      .eng-card-name .status-dot.online {
        background: #40916c;
        box-shadow: 0 0 6px #40916c;
      }
      .eng-card-name .status-dot.offline {
        background: #555;
      }
      .eng-card-tz {
        font-size: 0.75rem;
        color: #888;
      }
      .eng-card-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px 16px;
        font-size: 0.8rem;
      }
      .eng-card-details .label {
        color: #888;
      }
      .eng-card-details .value {
        color: #ddd;
        text-align: right;
        font-weight: 500;
      }
      .eng-card-details .value.warn {
        color: #f0a500;
      }
      .eng-card-details .value.good {
        color: #40916c;
      }
      .eng-card-progress {
        height: 4px;
        background: #2a2a4a;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
      }
      .eng-card-progress-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s;
      }

      /* TZ Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal {
        background: #16213e;
        border: 1px solid #4cc9f0;
        border-radius: 10px;
        padding: 24px;
        min-width: 300px;
      }
      .modal h3 {
        color: #fff;
        margin-bottom: 16px;
      }
      .modal select {
        width: 100%;
        background: #1a1a2e;
        color: #e0e0e0;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-bottom: 16px;
        appearance: auto;
      }
      .modal-btns {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .modal-btns button {
        padding: 6px 18px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .modal-btns .btn-save {
        background: #4cc9f0;
        color: #000;
        font-weight: 600;
      }
      .modal-btns .btn-cancel {
        background: #2a2a4a;
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <h1>Engineer Availability Schedule</h1>
    <p class="subtitle">Working hours across time zones</p>

    <div class="controls">
      <label for="tz-select">View in timezone:</label>
      <select id="tz-select">
        <option value="local">My Local Time</option>
        <option value="GMT">GMT / UTC</option>
        <option value="EST">EST (UTC-5)</option>
        <option value="CST">CST (UTC-6)</option>
        <option value="PST">PST (UTC-8)</option>
        <option value="CET">CET (UTC+1)</option>
        <option value="EET">EET (UTC+2)</option>
        <option value="IST">IST (UTC+5:30)</option>
        <option value="JST">JST (UTC+9)</option>
        <option value="AEST">AEST (UTC+10)</option>
      </select>
      <span class="edit-hint"><kbd>Ctrl</kbd> + Click cell to edit schedule</span>
      <button
        id="reset-btn"
        style="
          background: #2a2a4a;
          color: #f07070;
          border: 1px solid #444;
          border-radius: 6px;
          padding: 5px 12px;
          font-size: 0.75rem;
          cursor: pointer;
        "
        title="Reset all changes to original schedule"
      >
        Reset
      </button>
      <span class="current-time" id="current-time-display"></span>
    </div>

    <div class="schedule-wrapper" id="schedule-wrapper">
      <table id="schedule-table">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-swatch" style="background: #2d6a4f"></div>
        Available
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: #111; border: 1px solid #333"></div>
        Unavailable
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: #f72585; width: 3px; height: 16px"></div>
        Current time
      </div>
    </div>

    <div class="detail-panel">
      <h2 id="detail-heading">Engineer Status</h2>
      <div class="detail-grid" id="detail-grid"></div>
    </div>

    <div id="tooltip" class="tooltip" style="display: none"></div>
    <div id="modal-container"></div>

    <script>
      const TZ_OFFSETS = {
        GMT: 0,
        EST: -5,
        CST: -6,
        PST: -8,
        CET: 1,
        EET: 2,
        IST: 5.5,
        JST: 9,
        AEST: 10,
      };

      const TZ_NAMES = {
        GMT: "GMT (UTC+0)",
        EST: "EST (UTC-5)",
        CST: "CST (UTC-6)",
        PST: "PST (UTC-8)",
        CET: "CET (UTC+1)",
        EET: "EET (UTC+2)",
        IST: "IST (UTC+5:30)",
        JST: "JST (UTC+9)",
        AEST: "AEST (UTC+10)",
      };

      const STORAGE_KEY = "engineer-schedule-data";

      const DEFAULT_ENGINEERS = [
        {
          name: "Aleks",
          gmtHours: [7, 8, 9, 10, 11, 12, 13, 14, 15],
          notes: "Available later on Tuesdays",
          tz: "EET",
        },
        {
          name: "Michal",
          gmtHours: [8, 9, 10, 11, 12, 13, 14, 15, 16],
          notes: "",
          tz: "CET",
        },
        {
          name: "Mariusz",
          gmtHours: [7, 8, 9, 10, 11, 12, 13, 14],
          notes: "",
          tz: "CET",
        },
        {
          name: "Maksym",
          gmtHours: [11, 12, 13, 14, 15, 16, 17, 18, 19],
          notes: "",
          tz: "EET",
        },
        {
          name: "Daniel",
          gmtHours: [9, 10, 11, 12, 13, 14, 15, 16],
          notes: "Wed shift 3hrs later",
          tz: "CET",
        },
        {
          name: "Gino",
          gmtHours: [13, 14, 15, 16, 17, 18, 19, 20, 21],
          notes: "",
          tz: "EST",
        },
        {
          name: "Colin",
          gmtHours: [14, 15, 16, 17, 18, 19, 20, 21],
          notes: "",
          tz: "EST",
        },
        {
          name: "Samson",
          gmtHours: [14, 15, 16, 17, 18, 19, 20, 21],
          notes: "",
          tz: "EST",
        },
        {
          name: "Cody",
          gmtHours: [14, 15, 16, 17, 18, 19, 20, 21, 22],
          notes: "",
          tz: "CST",
        },
        {
          name: "Real",
          gmtHours: [13, 14, 16, 17, 18, 19, 20, 21, 22, 23],
          notes: "",
          tz: "PST",
        },
        {
          name: "Mike",
          gmtHours: [0, 1, 17, 18, 19, 20, 21, 22, 23],
          notes: "",
          tz: "PST",
        },
        {
          name: "JC",
          gmtHours: [0, 1, 17, 18, 19, 20, 21, 22, 23],
          notes: "",
          tz: "PST",
        },
      ];

      // ---- LocalStorage Persistence ----

      function saveData() {
        try {
          const data = engineers.map((e) => ({ name: e.name, gmtHours: e.gmtHours, notes: e.notes, tz: e.tz }));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          /* silently fail if storage unavailable */
        }
      }

      function loadData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          const data = JSON.parse(raw);
          if (!Array.isArray(data)) return null;
          return data;
        } catch (e) {
          return null;
        }
      }

      function resetToDefaults() {
        engineers.length = 0;
        DEFAULT_ENGINEERS.forEach((e) => engineers.push({ ...e, gmtHours: [...e.gmtHours] }));
        saveData();
        render();
      }

      // Initialize engineers from localStorage or defaults
      const engineers = [];
      (function initData() {
        const saved = loadData();
        if (saved && saved.length > 0) {
          saved.forEach((e) =>
            engineers.push({
              name: e.name || "Unknown",
              gmtHours: Array.isArray(e.gmtHours) ? e.gmtHours : [],
              notes: e.notes || "",
              tz: e.tz || "GMT",
            }),
          );
        } else {
          DEFAULT_ENGINEERS.forEach((e) => engineers.push({ ...e, gmtHours: [...e.gmtHours] }));
        }
      })();

      // ---- Utility Functions ----

      function getLocalOffset() {
        return -new Date().getTimezoneOffset() / 60;
      }
      function getOffset(tz) {
        if (tz === "local") return getLocalOffset();
        return TZ_OFFSETS[tz] ?? 0;
      }
      function getLocalTzName() {
        try {
          return Intl.DateTimeFormat().resolvedOptions().timeZone;
        } catch (e) {
          return "Local";
        }
      }
      function mod24(h) {
        return ((h % 24) + 24) % 24;
      }
      function gmtToTz(gmtHour, offset) {
        return mod24(gmtHour + offset);
      }

      function formatHour(h) {
        const hr = mod24(h);
        if (hr === 0) return "12a";
        if (hr < 12) return hr + "a";
        if (hr === 12) return "12p";
        return hr - 12 + "p";
      }

      function formatHourFull(h) {
        const hr = mod24(h);
        if (hr === 0) return "12:00 AM";
        if (hr < 12) return hr + ":00 AM";
        if (hr === 12) return "12:00 PM";
        return hr - 12 + ":00 PM";
      }

      function formatTimeFrac(fracHours) {
        const totalMin = Math.round(fracHours * 60);
        const hrs = Math.floor(totalMin / 60);
        const mins = totalMin % 60;
        const h = mod24(hrs);
        const ampm = h < 12 ? "AM" : "PM";
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${h12}:${String(mins).padStart(2, "0")} ${ampm}`;
      }

      function getCurrentGmtFrac() {
        const now = new Date();
        return now.getUTCHours() + now.getUTCMinutes() / 60 + now.getUTCSeconds() / 3600;
      }

      function getContiguousBlocks(gmtHours) {
        if (gmtHours.length === 0) return [];
        const sorted = [...gmtHours].sort((a, b) => a - b);
        const blocks = [];
        let start = sorted[0],
          end = sorted[0];
        for (let i = 1; i < sorted.length; i++) {
          if (sorted[i] === end + 1) {
            end = sorted[i];
          } else {
            blocks.push({ start, end: end + 1 }); // end is exclusive (end of that hour)
            start = sorted[i];
            end = sorted[i];
          }
        }
        blocks.push({ start, end: end + 1 });
        // Check wrap-around: if last block ends at 24 and first starts at 0, merge
        if (blocks.length > 1 && blocks[blocks.length - 1].end === 24 && blocks[0].start === 0) {
          blocks[0].start = blocks[blocks.length - 1].start;
          blocks.pop();
        }
        return blocks;
      }

      function getScheduleInfo(eng) {
        const gmtNow = getCurrentGmtFrac();
        const engOffset = getOffset(eng.tz);
        const gmtSet = new Set(eng.gmtHours);
        const currentGmtHour = Math.floor(gmtNow) % 24;
        const isOnline = gmtSet.has(mod24(currentGmtHour));

        // Find the current or next block this engineer is in
        const blocks = getContiguousBlocks(eng.gmtHours);
        let currentBlock = null;
        for (const b of blocks) {
          // Normalize: check if gmtNow falls within [b.start, b.end)
          if (b.start < b.end) {
            if (gmtNow >= b.start && gmtNow < b.end) currentBlock = b;
          } else {
            // wraps around midnight
            if (gmtNow >= b.start || gmtNow < b.end) currentBlock = b;
          }
        }

        const totalHours = eng.gmtHours.length;
        let workedHours = 0;
        let remainingHours = 0;
        let startGmt = null;
        let endGmt = null;

        if (currentBlock) {
          startGmt = currentBlock.start;
          endGmt = currentBlock.end;
          if (startGmt < endGmt) {
            workedHours = Math.max(0, gmtNow - startGmt);
            remainingHours = Math.max(0, endGmt - gmtNow);
          } else {
            // wraps
            if (gmtNow >= startGmt) {
              workedHours = gmtNow - startGmt;
              remainingHours = 24 - gmtNow + endGmt;
            } else {
              workedHours = 24 - startGmt + gmtNow;
              remainingHours = Math.max(0, endGmt - gmtNow);
            }
          }
        } else if (blocks.length > 0) {
          // Not currently online; find main block (longest)
          let main = blocks.reduce((a, b) => {
            const aLen = a.start < a.end ? a.end - a.start : 24 - a.start + a.end;
            const bLen = b.start < b.end ? b.end - b.start : 24 - b.start + b.end;
            return bLen > aLen ? b : a;
          });
          startGmt = main.start;
          endGmt = main.end;
        }

        const startLocal = startGmt !== null ? gmtToTz(startGmt, engOffset) : null;
        const endLocal = endGmt !== null ? gmtToTz(endGmt, engOffset) : null;
        const engLocalNow = mod24(gmtNow + engOffset);

        return {
          isOnline,
          workedHours,
          remainingHours,
          totalHours,
          startGmt,
          endGmt,
          startLocal,
          endLocal,
          engLocalNow,
          engOffset,
        };
      }

      function formatDuration(hours) {
        if (hours <= 0) return "0m";
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        if (h === 0) return `${m}m`;
        if (m === 0) return `${h}h`;
        return `${h}h ${m}m`;
      }

      // ---- Render ----

      function render() {
        const tz = document.getElementById("tz-select").value;
        const viewOffset = getOffset(tz);
        const thead = document.getElementById("table-head");
        const tbody = document.getElementById("table-body");
        const displayHours = [];
        for (let i = 0; i < 24; i++) displayHours.push(i);

        const nowGmtFrac = getCurrentGmtFrac();
        const nowTzFrac = mod24(nowGmtFrac + viewOffset);
        const nowTzHour = Math.floor(nowTzFrac);
        const tzLabel = tz === "local" ? getLocalTzName() : tz;

        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
        document.getElementById("current-time-display").textContent = `${timeStr} (${tzLabel})`;

        // Header
        let headHTML = `<tr class="header-row"><th class="name-col" style="background:#16213e">${tzLabel}</th>`;
        for (const h of displayHours) {
          headHTML += `<th class="hour-header ${h === nowTzHour ? "highlight" : ""}">${formatHour(h)}</th>`;
        }
        headHTML += `<th class="notes-col" style="background:#16213e">Notes</th></tr>`;
        thead.innerHTML = headHTML;

        // Body
        let bodyHTML = "";
        engineers.forEach((eng, idx) => {
          const gmtSet = new Set(eng.gmtHours);
          bodyHTML += `<tr class="name-row"><td class="name-col">${eng.name}<span class="pencil" data-eng="${idx}" title="Set ${eng.name}'s timezone">&#9998;</span></td>`;
          for (const h of displayHours) {
            const gmtH = mod24(Math.round(h - viewOffset));
            const avail = gmtSet.has(gmtH);
            bodyHTML += `<td class="hour-cell ${avail ? "available" : ""}" data-eng="${idx}" data-gmt="${gmtH}" data-display-hour="${h}"></td>`;
          }
          bodyHTML += `<td class="notes-col">${eng.notes}</td></tr>`;
        });

        // Count row
        bodyHTML += `<tr class="name-row"><td class="name-col" style="font-weight:700; color:#4cc9f0; font-size:0.8rem">Online</td>`;
        for (const h of displayHours) {
          const gmtH = mod24(Math.round(h - viewOffset));
          let count = 0;
          for (const eng of engineers) {
            if (eng.gmtHours.includes(gmtH)) count++;
          }
          const intensity = count > 0 ? Math.min(0.15 + count * 0.07, 0.9) : 0;
          const bg = count > 0 ? `rgba(76, 201, 240, ${intensity})` : "transparent";
          bodyHTML += `<td class="hour-cell" style="background:${bg}; font-size:0.75rem; font-weight:600; color:${count > 0 ? "#4cc9f0" : "#333"}">${count || ""}</td>`;
        }
        bodyHTML += `<td class="notes-col" style="font-size:0.75rem; color:#4cc9f0">Engineers online</td></tr>`;
        tbody.innerHTML = bodyHTML;

        drawTimeLine(nowTzFrac, displayHours);
        renderDetailPanel();
        attachCellEvents();
        attachPencilEvents();
      }

      function drawTimeLine(nowTzFrac, displayHours) {
        document.querySelectorAll(".current-time-line").forEach((el) => el.remove());
        const table = document.getElementById("schedule-table");
        const headerCells = table.querySelectorAll(".hour-header");
        if (headerCells.length === 0) return;

        const hourIndex = Math.floor(nowTzFrac);
        const fraction = nowTzFrac - hourIndex;
        const colIndex = displayHours.indexOf(hourIndex);
        if (colIndex < 0) return;

        const targetCell = headerCells[colIndex];
        if (!targetCell) return;
        const cellRect = targetCell.getBoundingClientRect();
        const leftPos = targetCell.offsetLeft + fraction * cellRect.width;

        const line = document.createElement("div");
        line.className = "current-time-line";
        line.style.left = leftPos + "px";
        line.style.top = "0";
        line.style.bottom = "0";
        line.innerHTML = '<div class="current-time-dot"></div>';

        const wrapper = document.getElementById("schedule-wrapper");
        wrapper.appendChild(line);
      }

      // ---- Detail Panel ----

      function renderDetailPanel() {
        const tz = document.getElementById("tz-select").value;
        const viewOffset = getOffset(tz);
        const grid = document.getElementById("detail-grid");

        // Sort: online first, then by remaining hours desc
        const infoList = engineers.map((eng, idx) => ({ eng, idx, info: getScheduleInfo(eng) }));
        infoList.sort((a, b) => {
          if (a.info.isOnline && !b.info.isOnline) return -1;
          if (!a.info.isOnline && b.info.isOnline) return 1;
          return b.info.remainingHours - a.info.remainingHours;
        });

        const onlineCount = infoList.filter((x) => x.info.isOnline).length;
        document.getElementById("detail-heading").textContent = `Engineer Status (${onlineCount} online)`;

        let html = "";
        for (const { eng, info } of infoList) {
          const onClass = info.isOnline ? "online" : "offline";
          const cardClass = info.isOnline ? "" : "offline-card";
          const localTimeStr = formatTimeFrac(info.engLocalNow);
          const startStr = info.startLocal !== null ? formatHourFull(info.startLocal) : "—";
          const endStr = info.endLocal !== null ? formatHourFull(info.endLocal) : "—";
          const endMyTime = info.endGmt !== null ? formatHourFull(gmtToTz(info.endGmt, viewOffset)) : "—";

          const pct =
            info.isOnline && info.totalHours > 0
              ? Math.min(100, Math.round((info.workedHours / (info.workedHours + info.remainingHours)) * 100))
              : 0;
          const barColor = info.remainingHours <= 1 && info.isOnline ? "#f0a500" : "#40916c";
          const remainClass = info.isOnline && info.remainingHours <= 1 ? "warn" : "good";

          html += `
    <div class="eng-card ${cardClass}">
      <div class="eng-card-header">
        <span class="eng-card-name"><span class="status-dot ${onClass}"></span>${eng.name}</span>
        <span class="eng-card-tz">${eng.tz} &middot; ${localTimeStr}</span>
      </div>
      <div class="eng-card-details">
        <span class="label">Schedule</span><span class="value">${startStr} &ndash; ${endStr}</span>
        <span class="label">Worked</span><span class="value">${info.isOnline ? formatDuration(info.workedHours) : "—"}</span>
        <span class="label">Remaining</span><span class="value ${remainClass}">${info.isOnline ? formatDuration(info.remainingHours) : "—"}</span>
        <span class="label">Leaves (your time)</span><span class="value">${info.isOnline ? endMyTime : "—"}</span>
      </div>
      ${info.isOnline ? `<div class="eng-card-progress"><div class="eng-card-progress-bar" style="width:${pct}%; background:${barColor}"></div></div>` : ""}
    </div>`;
        }
        grid.innerHTML = html;
      }

      // ---- Ctrl+Click Editing ----

      function attachCellEvents() {
        const cells = document.querySelectorAll(".hour-cell[data-eng]");
        cells.forEach((cell) => {
          cell.addEventListener("click", (e) => {
            if (!e.ctrlKey && !e.metaKey) return;
            e.preventDefault();
            const engIdx = parseInt(cell.dataset.eng);
            const gmtH = parseInt(cell.dataset.gmt);
            const eng = engineers[engIdx];
            const idx = eng.gmtHours.indexOf(gmtH);
            if (idx >= 0) {
              eng.gmtHours.splice(idx, 1);
            } else {
              eng.gmtHours.push(gmtH);
              eng.gmtHours.sort((a, b) => a - b);
            }
            saveData();
            render();
          });

          // Hover tooltip
          cell.addEventListener("mouseenter", (e) => showTooltip(e, cell));
          cell.addEventListener("mousemove", (e) => positionTooltip(e));
          cell.addEventListener("mouseleave", hideTooltip);
        });
      }

      // ---- Tooltip ----

      function showTooltip(e, cell) {
        const engIdx = parseInt(cell.dataset.eng);
        if (isNaN(engIdx)) return;
        const eng = engineers[engIdx];
        const info = getScheduleInfo(eng);
        const tz = document.getElementById("tz-select").value;
        const viewOffset = getOffset(tz);
        const displayHour = parseInt(cell.dataset.displayHour);
        const gmtH = parseInt(cell.dataset.gmt);
        const avail = eng.gmtHours.includes(gmtH);

        const engLocalTime = formatTimeFrac(info.engLocalNow);
        const statusClass = info.isOnline ? "online" : "offline";
        const statusText = info.isOnline ? "Online" : "Offline";

        const startLocal = info.startLocal !== null ? formatHourFull(info.startLocal) : "—";
        const endLocal = info.endLocal !== null ? formatHourFull(info.endLocal) : "—";
        const endMyTime = info.endGmt !== null ? formatHourFull(gmtToTz(info.endGmt, viewOffset)) : "—";

        let html = `<div class="tt-name"><span class="tt-status ${statusClass}"></span>${eng.name} &mdash; ${statusText}</div>`;
        html += `<div class="tt-row"><span class="tt-label">Their time now</span><span class="tt-value">${engLocalTime} (${eng.tz})</span></div>`;
        html += `<div class="tt-row"><span class="tt-label">Cell time (your view)</span><span class="tt-value">${formatHourFull(displayHour)}</span></div>`;
        html += `<div class="tt-divider"></div>`;

        if (info.isOnline) {
          html += `<div class="tt-row"><span class="tt-label">Worked so far</span><span class="tt-value">${formatDuration(info.workedHours)}</span></div>`;
          html += `<div class="tt-row"><span class="tt-label">Time remaining</span><span class="tt-value">${formatDuration(info.remainingHours)}</span></div>`;
          html += `<div class="tt-row"><span class="tt-label">Leaves (their time)</span><span class="tt-value">${endLocal}</span></div>`;
          html += `<div class="tt-row"><span class="tt-label">Leaves (your time)</span><span class="tt-value">${endMyTime}</span></div>`;
        } else {
          html += `<div class="tt-row"><span class="tt-label">Schedule</span><span class="tt-value">${startLocal} &ndash; ${endLocal} (${eng.tz})</span></div>`;
        }

        const tip = document.getElementById("tooltip");
        tip.innerHTML = html;
        tip.style.display = "block";
        positionTooltip(e);
      }

      function positionTooltip(e) {
        const tip = document.getElementById("tooltip");
        const pad = 14;
        let x = e.clientX + pad;
        let y = e.clientY + pad;
        const rect = tip.getBoundingClientRect();
        if (x + rect.width > window.innerWidth - 10) x = e.clientX - rect.width - pad;
        if (y + rect.height > window.innerHeight - 10) y = e.clientY - rect.height - pad;
        tip.style.left = x + "px";
        tip.style.top = y + "px";
      }

      function hideTooltip() {
        document.getElementById("tooltip").style.display = "none";
      }

      // ---- Pencil / TZ Modal ----

      function attachPencilEvents() {
        document.querySelectorAll(".pencil[data-eng]").forEach((el) => {
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            const idx = parseInt(el.dataset.eng);
            showTzModal(idx);
          });
        });
      }

      function showTzModal(engIdx) {
        const eng = engineers[engIdx];
        const container = document.getElementById("modal-container");
        let options = "";
        for (const [key, label] of Object.entries(TZ_NAMES)) {
          options += `<option value="${key}" ${eng.tz === key ? "selected" : ""}>${label}</option>`;
        }
        container.innerHTML = `
  <div class="modal-overlay" id="tz-modal">
    <div class="modal">
      <h3>Set timezone for ${eng.name}</h3>
      <select id="modal-tz-select">${options}</select>
      <div class="modal-btns">
        <button class="btn-cancel" id="modal-cancel">Cancel</button>
        <button class="btn-save" id="modal-save">Save</button>
      </div>
    </div>
  </div>`;

        document.getElementById("modal-cancel").onclick = () => {
          container.innerHTML = "";
        };
        document.getElementById("tz-modal").onclick = (e) => {
          if (e.target.id === "tz-modal") container.innerHTML = "";
        };
        document.getElementById("modal-save").onclick = () => {
          eng.tz = document.getElementById("modal-tz-select").value;
          container.innerHTML = "";
          saveData();
          render();
        };
      }

      // ---- Init ----

      // Persist the selected view timezone
      const VIEW_TZ_KEY = "engineer-schedule-view-tz";
      (function restoreViewTz() {
        try {
          const saved = localStorage.getItem(VIEW_TZ_KEY);
          if (saved) document.getElementById("tz-select").value = saved;
        } catch (e) {}
      })();

      document.getElementById("tz-select").addEventListener("change", () => {
        try {
          localStorage.setItem(VIEW_TZ_KEY, document.getElementById("tz-select").value);
        } catch (e) {}
        render();
      });

      document.getElementById("reset-btn").addEventListener("click", () => {
        if (confirm("Reset all schedule changes and timezones to defaults?")) {
          resetToDefaults();
        }
      });

      render();
      setInterval(render, 30000);
    </script>
  </body>
</html>
